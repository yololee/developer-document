# MySQL中MVCC介绍

## 通常如何进行并发控制

通过并发控制保证数据一致性的常见手段有：

（1）锁（Locking）；

（2）数据多版本（Multi Versioning）；

### 锁

**普通锁**

（1）操作数据前，锁住，实施互斥，不允许其他的并发任务操作；

（2）操作完成后，释放锁，让其他任务执行

> 简单的锁住太过粗暴，连“读任务”也无法并行，任务执行过程本质上是串行的

**共享锁与排他锁**

（1）共享锁之间不互斥，简记为：读读可以并行；

（2）排他锁与任何锁互斥，简记为：写读，写写不可以并行

> 可以看到，一旦写数据的任务没有完成，数据是不能被其他任务读取的，这对并发度有较大的影响

### 数据多版本

数据多版本是一种能够进一步提高并发的方法，它的**核心原理**是：

（1）写任务发生时，将数据克隆一份，以版本号区分；

（2）写任务操作新克隆的数据，直至提交；

（3）并发读任务可以继续读取旧版本的数据，不至于阻塞；

![image-20230719110823941](https://gitee.com/huanglei1111/phone-md/raw/master/images/image-20230719110823941.png)

如上图：

（1）最开始数据的版本是V0；

（2）T1时刻发起了一个写任务，这是把数据clone了一份，进行修改，版本变为V1，但任务还未完成；

（3）T2时刻并发了一个读任务，依然可以读V0版本的数据；

（4）T3时刻又并发了一个读任务，依然不会阻塞；

### 总结

**（1）普通锁**，本质是串行执行；

**（2）读写锁**，可以实现读读并发；

**（3）数据多版本**，可以实现读写并发；

## 为什么要有redo日志

> redo日志用于保障，已提交事务的ACID特性

数据库事务提交后，必须将更新后的数据刷到磁盘上，以保证ACID特性。磁盘**随机写**性能较低，如果每次都刷盘，会极大影响数据库的吞吐量。

优化方式是，将修改行为先写到redo日志里（此时变成了**顺序写**），再定期将数据刷到磁盘上，这样能极大提高性能。

假如某一时刻，数据库崩溃，还没来得及刷盘的数据，在数据库重启后，会重做redo日志里的内容，以保证已提交事务对数据产生的影响都刷到磁盘上

## 为什么要有undo日志

> undo日志用于保障，未提交事务不会对数据库的ACID特性产生影响

数据库事务未提交时，会将事务修改数据的镜像（即修改前的旧版本）存放到undo日志里，当事务回滚时，或者数据库奔溃时，可以利用undo日志，即旧版本数据，撤销未提交事务对数据库产生的影响。

## 什么事回滚段

存储undo日志的地方，是回滚段

![image-20230719111741491](https://gitee.com/huanglei1111/phone-md/raw/master/images/image-20230719111741491.png)

![image-20230719111820267](https://gitee.com/huanglei1111/phone-md/raw/master/images/image-20230719111820267.png)

可以看到：

（1）被删除前的(1, shenjian)作为旧版本数据，进入了回滚段；

（2）被修改前的(3, lisi)作为旧版本数据，进入了回滚段；

（3）被插入的数据，PK(4)进入了回滚段；

接下来，假如事务rollback，此时可以通过回滚段里的undo日志回滚

## InnoDB是基于多版本并发控制的存储引擎

InnoDB是高并发互联网场景最为推荐的存储引擎，根本原因，就是其**多版本并发控制**（Multi Version Concurrency Control, MVCC）。行锁，并发，事务回滚等多种特性都和MVCC相关。

MVCC就是通过“读取旧版本数据”来降低并发事务的锁冲突，提高任务的并发度

InnoDB的内核，会对所有row数据增加三个内部属性：

（1）**DB_TRX_ID**，6字节，记录每一行最近一次修改它的事务ID；

（2）**DB_ROLL_PTR**，7字节，记录指向回滚段undo日志的指针；

（3）**DB_ROW_ID**，6字节，单调递增的行ID；

**InnoDB为何能够做到这么高的并发**

回滚段里的数据，其实是历史数据的快照（snapshot），这些数据是不会被修改，select可以肆无忌惮的并发读取他们。

**快照读**（Snapshot Read），这种**一致性不加锁的读**（Consistent Nonlocking Read），就是InnoDB并发如此之高的核心原因之一。

